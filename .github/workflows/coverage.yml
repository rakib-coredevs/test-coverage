name: Run Code Coverage Check
on:
  workflow_dispatch:
  pull_request:

jobs:
  run_code_coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Get PR branch
        uses: xt0rted/pull-request-comment-branch@v1
        id: comment-branch

      - name: Set latest commit status as pending
        uses: myrotvorets/set-commit-status-action@master
        with:
          sha: ${{ steps.comment-branch.outputs.head_sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          status: pending

      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.comment-branch.outputs.head_ref }}

      - name: Setup Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Add comment to PR
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const { exec: execute } = require('child_process');

            execute('npm run test', (err, stdout, stderr) => {
              const message = `Output: \n\n\`\`\`${stdout}\`\`\`\n\nErrors: \n\n\`\`\`${stderr}\`\`\``;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            });

